************************************************************************
*                                                                      *
      SUBROUTINE KI_BHG_FILL(iret,www)      !      by droll (31/05/05)           *
*                                                                      *
*                provide individual beam halo events                   *
*                                                                      *
************************************************************************

      IMPLICIT NONE
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgrhists.inc"
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgcons.inc"
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgp_info.inc"
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgctrl.inc"
#include "GeneratorInterface/BeamHaloGenerator/interface/chepevt.inc"
#include "GeneratorInterface/BeamHaloGenerator/interface/mc_param.inc"
      REAL RAN01(1),E_KINE,LOG_EK,VERT_X,VERT_Y,COS_DX,COS_DY
      REAL PX,PY,PZ,E,M,VX,VY,VZ,T0
      REAL ABSMOM,P_BM_2,WEIGHT,P_MASS,SUM_BS
      INTEGER ID_PDG,ACC_EV,RANFLA
      INTEGER NI,M15_ID,IORIG,KORIG

      REAL    EF,W,X,Y,DCX,DCY,TOFF,PRIMEHITZ,
     &        ZORIG,XORIG,YORIG,EORIG,WORIG
c      REAL VXP,VYP,PROP,RXY
      INTEGER COUNT
      ! Convert MARS15 id's to PDG ID
      INTEGER IDCONVERT(40)
      DATA IDCONVERT/2212,2112,211,-211,321,-321,-13,13,22,11,-11,
     &              -2212,111,1,6,-104,-102,14,-14,12,-12,130,310,
     &               311,-311,3122,-3122,3222,3212,3112,-2112,3322,
     &               3312,3334,5112,5212,5222,-3322,-5132,-5332/      

      integer iret
      real www
      COUNT=0
      iret=0

      IF (GENMOD.EQ.1) THEN  ! event generator mode
        ID_PDG = RANFLA()
111     IF (ID_PDG.EQ.-13) THEN ! mu+
          CALL RNHRAN(H01MUP,N_BINS,L01MUP,W01MUP,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11MUP,N_BINS,L11MUP,W11MUP,VERT_X)
            CALL RNHRAN(H21MUP,N_BINS,L21MUP,W21MUP,VERT_Y)
            CALL RNHRAN(H31MUP,N_BINS,L31MUP,W31MUP,COS_DX)
            CALL RNHRAN(H41MUP,N_BINS,L41MUP,W41MUP,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12MUP,N_BINS,L12MUP,W12MUP,VERT_X)
            CALL RNHRAN(H22MUP,N_BINS,L22MUP,W22MUP,VERT_Y)
            CALL RNHRAN(H32MUP,N_BINS,L32MUP,W32MUP,COS_DX)
            CALL RNHRAN(H42MUP,N_BINS,L42MUP,W42MUP,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13MUP,N_BINS,L13MUP,W13MUP,VERT_X)
            CALL RNHRAN(H23MUP,N_BINS,L23MUP,W23MUP,VERT_Y)
            CALL RNHRAN(H33MUP,N_BINS,L33MUP,W33MUP,COS_DX)
            CALL RNHRAN(H43MUP,N_BINS,L43MUP,W43MUP,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14MUP,N_BINS,L14MUP,W14MUP,VERT_X)
            CALL RNHRAN(H24MUP,N_BINS,L24MUP,W24MUP,VERT_Y)
            CALL RNHRAN(H34MUP,N_BINS,L34MUP,W34MUP,COS_DX)
            CALL RNHRAN(H44MUP,N_BINS,L44MUP,W44MUP,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15MUP,N_BINS,L15MUP,W15MUP,VERT_X)
            CALL RNHRAN(H25MUP,N_BINS,L25MUP,W25MUP,VERT_Y)
            CALL RNHRAN(H35MUP,N_BINS,L35MUP,W35MUP,COS_DX)
            CALL RNHRAN(H45MUP,N_BINS,L45MUP,W45MUP,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16MUP,N_BINS,L16MUP,W16MUP,VERT_X)
            CALL RNHRAN(H26MUP,N_BINS,L26MUP,W26MUP,VERT_Y)
            CALL RNHRAN(H36MUP,N_BINS,L36MUP,W36MUP,COS_DX)
            CALL RNHRAN(H46MUP,N_BINS,L46MUP,W46MUP,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17MUP,N_BINS,L17MUP,W17MUP,VERT_X)
            CALL RNHRAN(H27MUP,N_BINS,L27MUP,W27MUP,VERT_Y)
            CALL RNHRAN(H37MUP,N_BINS,L37MUP,W37MUP,COS_DX)
            CALL RNHRAN(H47MUP,N_BINS,L47MUP,W47MUP,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18MUP,N_BINS,L18MUP,W18MUP,VERT_X)
            CALL RNHRAN(H28MUP,N_BINS,L28MUP,W28MUP,VERT_Y)
            CALL RNHRAN(H38MUP,N_BINS,L38MUP,W38MUP,COS_DX)
            CALL RNHRAN(H48MUP,N_BINS,L48MUP,W48MUP,COS_DY)
          ENDIF
        ELSEIF (ID_PDG.EQ.13) THEN ! mu-
          CALL RNHRAN(H01MUM,N_BINS,L01MUM,W01MUM,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11MUM,N_BINS,L11MUM,W11MUM,VERT_X)
            CALL RNHRAN(H21MUM,N_BINS,L21MUM,W21MUM,VERT_Y)
            CALL RNHRAN(H31MUM,N_BINS,L31MUM,W31MUM,COS_DX)
            CALL RNHRAN(H41MUM,N_BINS,L41MUM,W41MUM,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12MUM,N_BINS,L12MUM,W12MUM,VERT_X)
            CALL RNHRAN(H22MUM,N_BINS,L22MUM,W22MUM,VERT_Y)
            CALL RNHRAN(H32MUM,N_BINS,L32MUM,W32MUM,COS_DX)
            CALL RNHRAN(H42MUM,N_BINS,L42MUM,W42MUM,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13MUM,N_BINS,L13MUM,W13MUM,VERT_X)
            CALL RNHRAN(H23MUM,N_BINS,L23MUM,W23MUM,VERT_Y)
            CALL RNHRAN(H33MUM,N_BINS,L33MUM,W33MUM,COS_DX)
            CALL RNHRAN(H43MUM,N_BINS,L43MUM,W43MUM,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14MUM,N_BINS,L14MUM,W14MUM,VERT_X)
            CALL RNHRAN(H24MUM,N_BINS,L24MUM,W24MUM,VERT_Y)
            CALL RNHRAN(H34MUM,N_BINS,L34MUM,W34MUM,COS_DX)
            CALL RNHRAN(H44MUM,N_BINS,L44MUM,W44MUM,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15MUM,N_BINS,L15MUM,W15MUM,VERT_X)
            CALL RNHRAN(H25MUM,N_BINS,L25MUM,W25MUM,VERT_Y)
            CALL RNHRAN(H35MUM,N_BINS,L35MUM,W35MUM,COS_DX)
            CALL RNHRAN(H45MUM,N_BINS,L45MUM,W45MUM,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16MUM,N_BINS,L16MUM,W16MUM,VERT_X)
            CALL RNHRAN(H26MUM,N_BINS,L26MUM,W26MUM,VERT_Y)
            CALL RNHRAN(H36MUM,N_BINS,L36MUM,W36MUM,COS_DX)
            CALL RNHRAN(H46MUM,N_BINS,L46MUM,W46MUM,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17MUM,N_BINS,L17MUM,W17MUM,VERT_X)
            CALL RNHRAN(H27MUM,N_BINS,L27MUM,W27MUM,VERT_Y)
            CALL RNHRAN(H37MUM,N_BINS,L37MUM,W37MUM,COS_DX)
            CALL RNHRAN(H47MUM,N_BINS,L47MUM,W47MUM,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18MUM,N_BINS,L18MUM,W18MUM,VERT_X)
            CALL RNHRAN(H28MUM,N_BINS,L28MUM,W28MUM,VERT_Y)
            CALL RNHRAN(H38MUM,N_BINS,L38MUM,W38MUM,COS_DX)
            CALL RNHRAN(H48MUM,N_BINS,L48MUM,W48MUM,COS_DY)
          ENDIF
        ELSEIF (ID_PDG.EQ.211) THEN ! pi+
          CALL RNHRAN(H01PIP,N_BINS,L01PIP,W01PIP,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11PIP,N_BINS,L11PIP,W11PIP,VERT_X)
            CALL RNHRAN(H21PIP,N_BINS,L21PIP,W21PIP,VERT_Y)
            CALL RNHRAN(H31PIP,N_BINS,L31PIP,W31PIP,COS_DX)
            CALL RNHRAN(H41PIP,N_BINS,L41PIP,W41PIP,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12PIP,N_BINS,L12PIP,W12PIP,VERT_X)
            CALL RNHRAN(H22PIP,N_BINS,L22PIP,W22PIP,VERT_Y)
            CALL RNHRAN(H32PIP,N_BINS,L32PIP,W32PIP,COS_DX)
            CALL RNHRAN(H42PIP,N_BINS,L42PIP,W42PIP,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13PIP,N_BINS,L13PIP,W13PIP,VERT_X)
            CALL RNHRAN(H23PIP,N_BINS,L23PIP,W23PIP,VERT_Y)
            CALL RNHRAN(H33PIP,N_BINS,L33PIP,W33PIP,COS_DX)
            CALL RNHRAN(H43PIP,N_BINS,L43PIP,W43PIP,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14PIP,N_BINS,L14PIP,W14PIP,VERT_X)
            CALL RNHRAN(H24PIP,N_BINS,L24PIP,W24PIP,VERT_Y)
            CALL RNHRAN(H34PIP,N_BINS,L34PIP,W34PIP,COS_DX)
            CALL RNHRAN(H44PIP,N_BINS,L44PIP,W44PIP,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15PIP,N_BINS,L15PIP,W15PIP,VERT_X)
            CALL RNHRAN(H25PIP,N_BINS,L25PIP,W25PIP,VERT_Y)
            CALL RNHRAN(H35PIP,N_BINS,L35PIP,W35PIP,COS_DX)
            CALL RNHRAN(H45PIP,N_BINS,L45PIP,W45PIP,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16PIP,N_BINS,L16PIP,W16PIP,VERT_X)
            CALL RNHRAN(H26PIP,N_BINS,L26PIP,W26PIP,VERT_Y)
            CALL RNHRAN(H36PIP,N_BINS,L36PIP,W36PIP,COS_DX)
            CALL RNHRAN(H46PIP,N_BINS,L46PIP,W46PIP,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17PIP,N_BINS,L17PIP,W17PIP,VERT_X)
            CALL RNHRAN(H27PIP,N_BINS,L27PIP,W27PIP,VERT_Y)
            CALL RNHRAN(H37PIP,N_BINS,L37PIP,W37PIP,COS_DX)
            CALL RNHRAN(H47PIP,N_BINS,L47PIP,W47PIP,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18PIP,N_BINS,L18PIP,W18PIP,VERT_X)
            CALL RNHRAN(H28PIP,N_BINS,L28PIP,W28PIP,VERT_Y)
            CALL RNHRAN(H38PIP,N_BINS,L38PIP,W38PIP,COS_DX)
            CALL RNHRAN(H48PIP,N_BINS,L48PIP,W48PIP,COS_DY)
          ENDIF
        ELSEIF (ID_PDG.EQ.-211) THEN ! pi-
          CALL RNHRAN(H01PIM,N_BINS,L01PIM,W01PIM,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11PIM,N_BINS,L11PIM,W11PIM,VERT_X)
            CALL RNHRAN(H21PIM,N_BINS,L21PIM,W21PIM,VERT_Y)
            CALL RNHRAN(H31PIM,N_BINS,L31PIM,W31PIM,COS_DX)
            CALL RNHRAN(H41PIM,N_BINS,L41PIM,W41PIM,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12PIM,N_BINS,L12PIM,W12PIM,VERT_X)
            CALL RNHRAN(H22PIM,N_BINS,L22PIM,W22PIM,VERT_Y)
            CALL RNHRAN(H32PIM,N_BINS,L32PIM,W32PIM,COS_DX)
            CALL RNHRAN(H42PIM,N_BINS,L42PIM,W42PIM,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13PIM,N_BINS,L13PIM,W13PIM,VERT_X)
            CALL RNHRAN(H23PIM,N_BINS,L23PIM,W23PIM,VERT_Y)
            CALL RNHRAN(H33PIM,N_BINS,L33PIM,W33PIM,COS_DX)
            CALL RNHRAN(H43PIM,N_BINS,L43PIM,W43PIM,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14PIM,N_BINS,L14PIM,W14PIM,VERT_X)
            CALL RNHRAN(H24PIM,N_BINS,L24PIM,W24PIM,VERT_Y)
            CALL RNHRAN(H34PIM,N_BINS,L34PIM,W34PIM,COS_DX)
            CALL RNHRAN(H44PIM,N_BINS,L44PIM,W44PIM,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15PIM,N_BINS,L15PIM,W15PIM,VERT_X)
            CALL RNHRAN(H25PIM,N_BINS,L25PIM,W25PIM,VERT_Y)
            CALL RNHRAN(H35PIM,N_BINS,L35PIM,W35PIM,COS_DX)
            CALL RNHRAN(H45PIM,N_BINS,L45PIM,W45PIM,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16PIM,N_BINS,L16PIM,W16PIM,VERT_X)
            CALL RNHRAN(H26PIM,N_BINS,L26PIM,W26PIM,VERT_Y)
            CALL RNHRAN(H36PIM,N_BINS,L36PIM,W36PIM,COS_DX)
            CALL RNHRAN(H46PIM,N_BINS,L46PIM,W46PIM,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17PIM,N_BINS,L17PIM,W17PIM,VERT_X)
            CALL RNHRAN(H27PIM,N_BINS,L27PIM,W27PIM,VERT_Y)
            CALL RNHRAN(H37PIM,N_BINS,L37PIM,W37PIM,COS_DX)
            CALL RNHRAN(H47PIM,N_BINS,L47PIM,W47PIM,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18PIM,N_BINS,L18PIM,W18PIM,VERT_X)
            CALL RNHRAN(H28PIM,N_BINS,L28PIM,W28PIM,VERT_Y)
            CALL RNHRAN(H38PIM,N_BINS,L38PIM,W38PIM,COS_DX)
            CALL RNHRAN(H48PIM,N_BINS,L48PIM,W48PIM,COS_DY)
          ENDIF
        ELSEIF (ID_PDG.EQ.321) THEN ! K+
          CALL RNHRAN(H01KAP,N_BINS,L01KAP,W01KAP,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11KAP,N_BINS,L11KAP,W11KAP,VERT_X)
            CALL RNHRAN(H21KAP,N_BINS,L21KAP,W21KAP,VERT_Y)
            CALL RNHRAN(H31KAP,N_BINS,L31KAP,W31KAP,COS_DX)
            CALL RNHRAN(H41KAP,N_BINS,L41KAP,W41KAP,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12KAP,N_BINS,L12KAP,W12KAP,VERT_X)
            CALL RNHRAN(H22KAP,N_BINS,L22KAP,W22KAP,VERT_Y)
            CALL RNHRAN(H32KAP,N_BINS,L32KAP,W32KAP,COS_DX)
            CALL RNHRAN(H42KAP,N_BINS,L42KAP,W42KAP,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13KAP,N_BINS,L13KAP,W13KAP,VERT_X)
            CALL RNHRAN(H23KAP,N_BINS,L23KAP,W23KAP,VERT_Y)
            CALL RNHRAN(H33KAP,N_BINS,L33KAP,W33KAP,COS_DX)
            CALL RNHRAN(H43KAP,N_BINS,L43KAP,W43KAP,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14KAP,N_BINS,L14KAP,W14KAP,VERT_X)
            CALL RNHRAN(H24KAP,N_BINS,L24KAP,W24KAP,VERT_Y)
            CALL RNHRAN(H34KAP,N_BINS,L34KAP,W34KAP,COS_DX)
            CALL RNHRAN(H44KAP,N_BINS,L44KAP,W44KAP,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15KAP,N_BINS,L15KAP,W15KAP,VERT_X)
            CALL RNHRAN(H25KAP,N_BINS,L25KAP,W25KAP,VERT_Y)
            CALL RNHRAN(H35KAP,N_BINS,L35KAP,W35KAP,COS_DX)
            CALL RNHRAN(H45KAP,N_BINS,L45KAP,W45KAP,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16KAP,N_BINS,L16KAP,W16KAP,VERT_X)
            CALL RNHRAN(H26KAP,N_BINS,L26KAP,W26KAP,VERT_Y)
            CALL RNHRAN(H36KAP,N_BINS,L36KAP,W36KAP,COS_DX)
            CALL RNHRAN(H46KAP,N_BINS,L46KAP,W46KAP,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17KAP,N_BINS,L17KAP,W17KAP,VERT_X)
            CALL RNHRAN(H27KAP,N_BINS,L27KAP,W27KAP,VERT_Y)
            CALL RNHRAN(H37KAP,N_BINS,L37KAP,W37KAP,COS_DX)
            CALL RNHRAN(H47KAP,N_BINS,L47KAP,W47KAP,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18KAP,N_BINS,L18KAP,W18KAP,VERT_X)
            CALL RNHRAN(H28KAP,N_BINS,L28KAP,W28KAP,VERT_Y)
            CALL RNHRAN(H38KAP,N_BINS,L38KAP,W38KAP,COS_DX)
            CALL RNHRAN(H48KAP,N_BINS,L48KAP,W48KAP,COS_DY)
          ENDIF
        ELSEIF (ID_PDG.EQ.-321) THEN ! K-
          CALL RNHRAN(H01KAM,N_BINS,L01KAM,W01KAM,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11KAM,N_BINS,L11KAM,W11KAM,VERT_X)
            CALL RNHRAN(H21KAM,N_BINS,L21KAM,W21KAM,VERT_Y)
            CALL RNHRAN(H31KAM,N_BINS,L31KAM,W31KAM,COS_DX)
            CALL RNHRAN(H41KAM,N_BINS,L41KAM,W41KAM,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12KAM,N_BINS,L12KAM,W12KAM,VERT_X)
            CALL RNHRAN(H22KAM,N_BINS,L22KAM,W22KAM,VERT_Y)
            CALL RNHRAN(H32KAM,N_BINS,L32KAM,W32KAM,COS_DX)
            CALL RNHRAN(H42KAM,N_BINS,L42KAM,W42KAM,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13KAM,N_BINS,L13KAM,W13KAM,VERT_X)
            CALL RNHRAN(H23KAM,N_BINS,L23KAM,W23KAM,VERT_Y)
            CALL RNHRAN(H33KAM,N_BINS,L33KAM,W33KAM,COS_DX)
            CALL RNHRAN(H43KAM,N_BINS,L43KAM,W43KAM,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14KAM,N_BINS,L14KAM,W14KAM,VERT_X)
            CALL RNHRAN(H24KAM,N_BINS,L24KAM,W24KAM,VERT_Y)
            CALL RNHRAN(H34KAM,N_BINS,L34KAM,W34KAM,COS_DX)
            CALL RNHRAN(H44KAM,N_BINS,L44KAM,W44KAM,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15KAM,N_BINS,L15KAM,W15KAM,VERT_X)
            CALL RNHRAN(H25KAM,N_BINS,L25KAM,W25KAM,VERT_Y)
            CALL RNHRAN(H35KAM,N_BINS,L35KAM,W35KAM,COS_DX)
            CALL RNHRAN(H45KAM,N_BINS,L45KAM,W45KAM,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16KAM,N_BINS,L16KAM,W16KAM,VERT_X)
            CALL RNHRAN(H26KAM,N_BINS,L26KAM,W26KAM,VERT_Y)
            CALL RNHRAN(H36KAM,N_BINS,L36KAM,W36KAM,COS_DX)
            CALL RNHRAN(H46KAM,N_BINS,L46KAM,W46KAM,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17KAM,N_BINS,L17KAM,W17KAM,VERT_X)
            CALL RNHRAN(H27KAM,N_BINS,L27KAM,W27KAM,VERT_Y)
            CALL RNHRAN(H37KAM,N_BINS,L37KAM,W37KAM,COS_DX)
            CALL RNHRAN(H47KAM,N_BINS,L47KAM,W47KAM,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18KAM,N_BINS,L18KAM,W18KAM,VERT_X)
            CALL RNHRAN(H28KAM,N_BINS,L28KAM,W28KAM,VERT_Y)
            CALL RNHRAN(H38KAM,N_BINS,L38KAM,W38KAM,COS_DX)
            CALL RNHRAN(H48KAM,N_BINS,L48KAM,W48KAM,COS_DY)
          ENDIF
        ELSEIF (ID_PDG.EQ.2212) THEN ! p+
          CALL RNHRAN(H01PRO,N_BINS,L01PRO,W01PRO,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11PRO,N_BINS,L11PRO,W11PRO,VERT_X)
            CALL RNHRAN(H21PRO,N_BINS,L21PRO,W21PRO,VERT_Y)
            CALL RNHRAN(H31PRO,N_BINS,L31PRO,W31PRO,COS_DX)
            CALL RNHRAN(H41PRO,N_BINS,L41PRO,W41PRO,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12PRO,N_BINS,L12PRO,W12PRO,VERT_X)
            CALL RNHRAN(H22PRO,N_BINS,L22PRO,W22PRO,VERT_Y)
            CALL RNHRAN(H32PRO,N_BINS,L32PRO,W32PRO,COS_DX)
            CALL RNHRAN(H42PRO,N_BINS,L42PRO,W42PRO,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13PRO,N_BINS,L13PRO,W13PRO,VERT_X)
            CALL RNHRAN(H23PRO,N_BINS,L23PRO,W23PRO,VERT_Y)
            CALL RNHRAN(H33PRO,N_BINS,L33PRO,W33PRO,COS_DX)
            CALL RNHRAN(H43PRO,N_BINS,L43PRO,W43PRO,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14PRO,N_BINS,L14PRO,W14PRO,VERT_X)
            CALL RNHRAN(H24PRO,N_BINS,L24PRO,W24PRO,VERT_Y)
            CALL RNHRAN(H34PRO,N_BINS,L34PRO,W34PRO,COS_DX)
            CALL RNHRAN(H44PRO,N_BINS,L44PRO,W44PRO,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15PRO,N_BINS,L15PRO,W15PRO,VERT_X)
            CALL RNHRAN(H25PRO,N_BINS,L25PRO,W25PRO,VERT_Y)
            CALL RNHRAN(H35PRO,N_BINS,L35PRO,W35PRO,COS_DX)
            CALL RNHRAN(H45PRO,N_BINS,L45PRO,W45PRO,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16PRO,N_BINS,L16PRO,W16PRO,VERT_X)
            CALL RNHRAN(H26PRO,N_BINS,L26PRO,W26PRO,VERT_Y)
            CALL RNHRAN(H36PRO,N_BINS,L36PRO,W36PRO,COS_DX)
            CALL RNHRAN(H46PRO,N_BINS,L46PRO,W46PRO,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17PRO,N_BINS,L17PRO,W17PRO,VERT_X)
            CALL RNHRAN(H27PRO,N_BINS,L27PRO,W27PRO,VERT_Y)
            CALL RNHRAN(H37PRO,N_BINS,L37PRO,W37PRO,COS_DX)
            CALL RNHRAN(H47PRO,N_BINS,L47PRO,W47PRO,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18PRO,N_BINS,L18PRO,W18PRO,VERT_X)
            CALL RNHRAN(H28PRO,N_BINS,L28PRO,W28PRO,VERT_Y)
            CALL RNHRAN(H38PRO,N_BINS,L38PRO,W38PRO,COS_DX)
            CALL RNHRAN(H48PRO,N_BINS,L48PRO,W48PRO,COS_DY)
          ENDIF
        ELSEIF (ID_PDG.EQ.2112) THEN ! n0
          CALL RNHRAN(H01NEU,N_BINS,L01NEU,W01NEU,LOG_EK)
          E_KINE = EXP(LOG_EK)
          IF     (E_KINE.GE.1.0000.AND.E_KINE.LT.3.0000) THEN
            CALL RNHRAN(H11NEU,N_BINS,L11NEU,W11NEU,VERT_X)
            CALL RNHRAN(H21NEU,N_BINS,L21NEU,W21NEU,VERT_Y)
            CALL RNHRAN(H31NEU,N_BINS,L31NEU,W31NEU,COS_DX)
            CALL RNHRAN(H41NEU,N_BINS,L41NEU,W41NEU,COS_DY)
          ELSEIF (E_KINE.GE.3.0000.AND.E_KINE.LT.9.0000) THEN
            CALL RNHRAN(H12NEU,N_BINS,L12NEU,W12NEU,VERT_X)
            CALL RNHRAN(H22NEU,N_BINS,L22NEU,W22NEU,VERT_Y)
            CALL RNHRAN(H32NEU,N_BINS,L32NEU,W32NEU,COS_DX)
            CALL RNHRAN(H42NEU,N_BINS,L42NEU,W42NEU,COS_DY)
          ELSEIF (E_KINE.GE.9.0000.AND.E_KINE.LT.27.000) THEN
            CALL RNHRAN(H13NEU,N_BINS,L13NEU,W13NEU,VERT_X)
            CALL RNHRAN(H23NEU,N_BINS,L23NEU,W23NEU,VERT_Y)
            CALL RNHRAN(H33NEU,N_BINS,L33NEU,W33NEU,COS_DX)
            CALL RNHRAN(H43NEU,N_BINS,L43NEU,W43NEU,COS_DY)
          ELSEIF (E_KINE.GE.27.000.AND.E_KINE.LT.81.000) THEN
            CALL RNHRAN(H14NEU,N_BINS,L14NEU,W14NEU,VERT_X)
            CALL RNHRAN(H24NEU,N_BINS,L24NEU,W24NEU,VERT_Y)
            CALL RNHRAN(H34NEU,N_BINS,L34NEU,W34NEU,COS_DX)
            CALL RNHRAN(H44NEU,N_BINS,L44NEU,W44NEU,COS_DY)
          ELSEIF (E_KINE.GE.81.000.AND.E_KINE.LT.243.00) THEN
            CALL RNHRAN(H15NEU,N_BINS,L15NEU,W15NEU,VERT_X)
            CALL RNHRAN(H25NEU,N_BINS,L25NEU,W25NEU,VERT_Y)
            CALL RNHRAN(H35NEU,N_BINS,L35NEU,W35NEU,COS_DX)
            CALL RNHRAN(H45NEU,N_BINS,L45NEU,W45NEU,COS_DY)
          ELSEIF (E_KINE.GE.243.00.AND.E_KINE.LT.729.00) THEN
            CALL RNHRAN(H16NEU,N_BINS,L16NEU,W16NEU,VERT_X)
            CALL RNHRAN(H26NEU,N_BINS,L26NEU,W26NEU,VERT_Y)
            CALL RNHRAN(H36NEU,N_BINS,L36NEU,W36NEU,COS_DX)
            CALL RNHRAN(H46NEU,N_BINS,L46NEU,W46NEU,COS_DY)
          ELSEIF (E_KINE.GE.729.00.AND.E_KINE.LT.2187.0) THEN
            CALL RNHRAN(H17NEU,N_BINS,L17NEU,W17NEU,VERT_X)
            CALL RNHRAN(H27NEU,N_BINS,L27NEU,W27NEU,VERT_Y)
            CALL RNHRAN(H37NEU,N_BINS,L37NEU,W37NEU,COS_DX)
            CALL RNHRAN(H47NEU,N_BINS,L47NEU,W47NEU,COS_DY)
          ELSEIF (E_KINE.GE.2187.0.AND.E_KINE.LT.7000.0) THEN
            CALL RNHRAN(H18NEU,N_BINS,L18NEU,W18NEU,VERT_X)
            CALL RNHRAN(H28NEU,N_BINS,L28NEU,W28NEU,VERT_Y)
            CALL RNHRAN(H38NEU,N_BINS,L38NEU,W38NEU,COS_DX)
            CALL RNHRAN(H48NEU,N_BINS,L48NEU,W48NEU,COS_DY)
          ENDIF
        ELSE
          PRINT*,'ERROR: unknown particle flavor'
          STOP
        ENDIF
        IF (ACC_EV(ID_PDG,E_KINE).EQ.0) GOTO 111
        WEIGHT = 1.
      ENDIF
      
      IF (GENMOD.EQ.2) THEN  ! event reading mode
222     WEIGHT = 0.
        IF (N_READ.EQ.F1N_EV) RETURN
        READ(22,*) ID_PDG,WEIGHT,E_KINE,VERT_X,VERT_Y,COS_DX,COS_DY
        N_READ = N_READ + 1.
        IF (ACC_EV(ID_PDG,E_KINE).EQ.1) THEN
          IF (ID_PDG.EQ. -13) R_MU_P = R_MU_P + WEIGHT ! mu+
          IF (ID_PDG.EQ.  13) R_MU_M = R_MU_M + WEIGHT ! mu-
          IF (ID_PDG.EQ. 211) R_PI_P = R_PI_P + WEIGHT ! pi+
          IF (ID_PDG.EQ.-211) R_PI_M = R_PI_M + WEIGHT ! pi-
          IF (ID_PDG.EQ. 321) R_KA_P = R_KA_P + WEIGHT ! K+
          IF (ID_PDG.EQ.-321) R_KA_M = R_KA_M + WEIGHT ! K-
          IF (ID_PDG.EQ.2212) R_PROT = R_PROT + WEIGHT ! p+
          IF (ID_PDG.EQ.2112) R_NEUT = R_NEUT + WEIGHT ! n0
        ELSE
          GOTO 222
        ENDIF
        SUM_BS = REAL(LHC_B1+LHC_B2) ! sum of beams
        WEIGHT = WEIGHT*SUM_BS
      ENDIF


      IF (GENMOD.EQ.3) THEN  ! event reading mode
223     WEIGHT = 0.
C        IF (N_READ.EQ.289945) RETURN

        write(6,*) 'MAXLINE and LINE ',N_READ,MAXLINE
C        IF (N_READ.GE.289945) THEN
          IF (NINT(N_READ).GE.MAXLINE) THEN
           iret = -1
           return
        endif
        READ(22,*,END=333) NI,M15_ID,EF,W,X,Y,DCX,DCY,TOFF,PRIMEHITZ,
     &                     ZORIG,XORIG,YORIG,EORIG,WORIG,IORIG,KORIG
C        READ(22,*) ID_PDG,WEIGHT,E_KINE,VERT_X,VERT_Y,COS_DX,COS_DY
        IF( NILAST .NE. NI ) THEN
           NILAST = NI
           NPRIME = NPRIME + 1
        ENDIF
        N_READ = N_READ + 1.
        ID_PDG = IDCONVERT(M15_ID)
        WEIGHT = W*W0
        E_KINE = EF
        VERT_X = -Y
        VERT_Y = -X
        COS_DX = DCX
        COS_DY = DCY
        write(6,*) 'Here at N_READ ',N_READ,OFFSET,NI,EF,TOFF
        IF (ACC_EV(ID_PDG,E_KINE).EQ.1) THEN
           IF (ID_PDG.EQ. -13) R_MU_P = R_MU_P + WEIGHT ! mu+
           IF (ID_PDG.EQ.  13) R_MU_M = R_MU_M + WEIGHT ! mu-
           IF (ID_PDG.EQ. 211) R_PI_P = R_PI_P + WEIGHT ! pi+
           IF (ID_PDG.EQ.-211) R_PI_M = R_PI_M + WEIGHT ! pi-
           IF (ID_PDG.EQ. 321) R_KA_P = R_KA_P + WEIGHT ! K+
           IF (ID_PDG.EQ.-321) R_KA_M = R_KA_M + WEIGHT ! K-
           IF (ID_PDG.EQ.2212) R_PROT = R_PROT + WEIGHT ! p+
           IF (ID_PDG.EQ.2112) R_NEUT = R_NEUT + WEIGHT ! n0
           if( IW_MUO .eq. 1 ) then
              if( abs( id_pdg ) .eq. 13 ) nstack = nstack + 1
           endif
           if( IW_HAD .eq. 1 ) then
              if( abs( id_pdg ) .eq. 211 )  nstack = nstack + 1
              if( abs( id_pdg ) .eq. 321 )  nstack = nstack + 1
              if( abs( id_pdg ) .eq. 2212 ) nstack = nstack + 1
              if( abs( id_pdg ) .eq. 2112 ) nstack = nstack + 1
           endif
        ELSE
          GOTO 223
        ENDIF
        SUM_BS = REAL(LHC_B1+LHC_B2) ! sum of beams
        WEIGHT = WEIGHT*SUM_BS
      ENDIF

      IF (GENMOD.GE.1) THEN
        ! number of generated particles
        NP_GEN = NP_GEN + 1.
        ! calculate HEP variables
        ! including coordinate transformations to detector coordinates
        ! and transformation to HEPEVT units (if necessary)
        VERT_X = VERT_X*10.  !  [cm] -> [mm]
        VERT_Y = VERT_Y*10.  !  [cm] -> [mm]
        M  = P_MASS(ID_PDG)
        E  = E_KINE + M
        ABSMOM = SQRT(E**2 - M**2)
      IF (GENMOD.EQ.3) THEN
        PX = -ABSMOM*COS_DY
        PY =  ABSMOM*COS_DX
      ELSE
        PX = -ABSMOM*COS_DX
        PY =  ABSMOM*COS_DY
      ENDIF
        PZ = -SQRT(ABSMOM**2 - PX**2 -PY**2)
        VX = VERT_X
        VY = VERT_Y
        VZ = Z_ZERO
cep        T0 = T_ZERO*SP_O_L
        T0 = (T_ZERO + idx_shift_bx*BXNS) * SP_O_L
! T0 calc from Mars added time shift too
        if( genmod .eq. 3 ) then
           VZ = 22600.0
           T0 = -2.0*TOFF*8.3e7+(idx_shift_bx*BXNS* SP_O_L)
        endif

                                         P_BM_2 = 0.5
        IF (LHC_B1.EQ.1.AND.LHC_B2.EQ.0) P_BM_2 = 0.0
        IF (LHC_B1.EQ.0.AND.LHC_B2.EQ.1) P_BM_2 = 1.0
        CALL RANLUX(RAN01,1)
        IF(RAN01(1).LT.P_BM_2) THEN ! LHC beam 2
          VZ = -VZ
          PZ = -PZ
        ENDIF
        ! fill HEPEVT common block
        NEVHEP = NP_GEN
        NHEP = 1            !  number of particles
        ISTHEP(1) = 1       !  status: final state
        IDHEP(1) = ID_PDG   !  flavor code
        JMOHEP(1,1) = 0     !  1st mother
        JMOHEP(2,1) = 0     !  2nd mother
        JDAHEP(1,1) = 0     !  1st daughter
        JDAHEP(2,1) = 0     !  2nd daughter
        PHEP(1,1) = PX      !  [GeV/c]
        PHEP(2,1) = PY      !  [GeV/c]
        PHEP(3,1) = PZ      !  [GeV/c]
        PHEP(4,1) = E       !  [GeV]
        PHEP(5,1) = M       !  [GeV/c^2]
        VHEP(1,1) = VX      !  [mm]
        VHEP(2,1) = VY      !  [mm]
        VHEP(3,1) = VZ      !  [mm]
        VHEP(4,1) = T0      !  [mm/c]
        WGTMCP = WEIGHT     !  event weight
        NVRMCP = 1          !  number of partons
        VARMCP(NVRMCP) = 0. !  parton p_t (to VARMCP(1))
        nmulti = 1
        eventweightlh = WGTMCP
        eventweightmulti(1) = WGTMCP
        www = weight
      ENDIF

      RETURN                                                                   
 333  RETURN
      END

************************************************************************
      INTEGER FUNCTION ACC_EV(ID_PDG,E_KINE)    !   by droll (17/12/04)
*             check whether event is acceptable or not
************************************************************************
      IMPLICIT NONE
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgcons.inc"
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgp_info.inc"
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgctrl.inc"
      INTEGER ID_PDG
      REAL E_KINE

      ACC_EV = 0 ! default: do not accept event
      IF (IW_MUO.EQ.1) THEN
        IF (E_KINE.GT.EMUMIN.AND.E_KINE.LT.EMUMAX) THEN
          IF (ID_PDG.EQ. -13) ACC_EV = 1 ! accept mu+
	  IF (ID_PDG.EQ.  13) ACC_EV = 1 ! accept mu-
        ENDIF
      ENDIF
      IF (IW_HAD.EQ.1) THEN
        IF (E_KINE.GT.EPIMIN.AND.E_KINE.LT.EPIMAX) THEN
          IF (ID_PDG.EQ. 211) ACC_EV = 1 ! accept pi+
          IF (ID_PDG.EQ.-211) ACC_EV = 1 ! accept pi-
        ENDIF
        IF (E_KINE.GT.EKAMIN.AND.E_KINE.LT.EKAMAX) THEN
          IF (ID_PDG.EQ. 321) ACC_EV = 1 ! accept K+
          IF (ID_PDG.EQ.-321) ACC_EV = 1 ! accept K-
        ENDIF
        IF (E_KINE.GT.EPRMIN.AND.E_KINE.LT.EPRMAX) THEN
          IF (ID_PDG.EQ.2212) ACC_EV = 1 ! accept p+
        ENDIF
        IF (E_KINE.GT.ENEMIN.AND.E_KINE.LT.ENEMAX) THEN
          IF (ID_PDG.EQ.2112) ACC_EV = 1 ! accept n0
        ENDIF
      ENDIF

      RETURN

      END

************************************************************************
      INTEGER FUNCTION RANFLA()    !  by droll (18/12/04)
*             generate random particle flavors
************************************************************************
      IMPLICIT NONE
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgp_info.inc"
      DOUBLE PRECISION RAN01(1),L_1ST
      DOUBLE PRECISION L_MUP,L_MUM,L_PIP,L_PIM,L_KAP,L_KAM,L_PRO,L_NEU

      L_1ST = 0D0
      L_MUP = FR_MUP + L_1ST
      L_MUM = FR_MUM + L_MUP
      L_PIP = FR_PIP + L_MUM
      L_PIM = FR_PIM + L_PIP
      L_KAP = FR_KAP + L_PIM
      L_KAM = FR_KAM + L_KAP
      L_PRO = FR_PRO + L_KAM
      L_NEU = FR_NEU + L_PRO
      CALL RM48(RAN01,1)
      IF     (RAN01(1).GE.L_1ST.AND.RAN01(1).LT.L_MUP) THEN
        RANFLA =  -13  !  mu+
      ELSEIF (RAN01(1).GE.L_MUP.AND.RAN01(1).LT.L_MUM) THEN
        RANFLA =   13  !  mu-
      ELSEIF (RAN01(1).GE.L_MUM.AND.RAN01(1).LT.L_PIP) THEN 
        RANFLA =  211  !  pi+
      ELSEIF (RAN01(1).GE.L_PIP.AND.RAN01(1).LT.L_PIM) THEN
        RANFLA = -211  !  pi-
      ELSEIF (RAN01(1).GE.L_PIM.AND.RAN01(1).LT.L_KAP) THEN
        RANFLA =  321  !  K+
      ELSEIF (RAN01(1).GE.L_KAP.AND.RAN01(1).LT.L_KAM) THEN
        RANFLA = -321  !  K-
      ELSEIF (RAN01(1).GE.L_KAM.AND.RAN01(1).LT.L_PRO) THEN
        RANFLA = 2212  !  p+
      ELSEIF (RAN01(1).GE.L_PRO.AND.RAN01(1).LT.L_NEU) THEN
        RANFLA = 2112  !  n0
      ELSE
        RANFLA =    0  !  undefined
      ENDIF

      RETURN
      END

************************************************************************
      REAL FUNCTION P_MASS(ID_PDG)    !  by droll (18/12/04)
*          provide particle mass for a certain flavor
************************************************************************
      IMPLICIT NONE
#include "GeneratorInterface/BeamHaloGenerator/interface/bhgcons.inc"
      INTEGER ID_PDG

      P_MASS = 0.  !  default: massless
      IF (ID_PDG.EQ. -13) P_MASS = M_MUON  !  mu+
      IF (ID_PDG.EQ.  13) P_MASS = M_MUON  !  mu-
      IF (ID_PDG.EQ. 211) P_MASS = M_PION  !  pi+
      IF (ID_PDG.EQ.-211) P_MASS = M_PION  !  pi-
      IF (ID_PDG.EQ. 321) P_MASS = M_KAON  !  K+
      IF (ID_PDG.EQ.-321) P_MASS = M_KAON  !  K-
      IF (ID_PDG.EQ.2212) P_MASS = M_PROT  !  p+
      IF (ID_PDG.EQ.2112) P_MASS = M_NEUT  !  n0

      RETURN
      END
